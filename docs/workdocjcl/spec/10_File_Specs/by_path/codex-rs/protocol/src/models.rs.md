# `codex-rs/protocol/src/models.rs`

## Identity
- kind: `source`
- ext: `.rs`
- size_bytes: `58644`
- sha256: `172123b2e4374c4962130781977fa2d6ec8ae18c6ee6f11e1aae6f33ccd8842f`
- generated_utc: `2026-02-08T10:45:38Z`

## Purpose (Why)
Source file implementing exported/public items listed below.

## Interfaces (Inputs/Outputs)
### Inputs
- filesystem: `codex-rs/protocol/src/models.rs` (read)

### Outputs / Side Effects
- writes to filesystem
- writes to stdout/stderr

## Public Surface (auto)
- `pub enum SandboxPermissions {`
- `pub fn requires_escalated_permissions(self) -> bool {`
- `pub enum ResponseInputItem {`
- `pub enum ContentItem {`
- `pub enum MessagePhase {`
- `pub enum ResponseItem {`
- `pub struct BaseInstructions {`
- `pub struct DeveloperInstructions {`
- `pub fn from(`
- `pub fn into_text(self) -> String {`
- `pub fn concat(self, other: impl Into<DeveloperInstructions>) -> Self {`
- `pub fn model_switch_message(model_instructions: String) -> Self {`
- `pub fn personality_spec_message(spec: String) -> Self {`
- `pub fn from_policy(`
- `pub fn from_collaboration_mode(collaboration_mode: &CollaborationMode) -> Option<Self> {`
- `pub fn format_allow_prefixes(prefixes: Vec<Vec<String>>) -> Option<String> {`
- `pub fn image_open_tag_text() -> String {`
- `pub fn image_close_tag_text() -> String {`
- `pub fn local_image_label_text(label_number: usize) -> String {`
- `pub fn local_image_open_tag_text(label_number: usize) -> String {`
- `pub fn is_local_image_open_tag_text(text: &str) -> bool {`
- `pub fn is_local_image_close_tag_text(text: &str) -> bool {`
- `pub fn is_image_open_tag_text(text: &str) -> bool {`
- `pub fn is_image_close_tag_text(text: &str) -> bool {`
- `pub fn local_image_content_items_with_label_number(`
- `pub enum LocalShellStatus {`
- `pub enum LocalShellAction {`
- `pub struct LocalShellExecAction {`
- `pub enum WebSearchAction {`
- `pub enum ReasoningItemReasoningSummary {`
- `pub enum ReasoningItemContent {`
- `pub struct ShellToolCallParams {`
- `pub struct ShellCommandToolCallParams {`
- `pub enum FunctionCallOutputContentItem {`
- `pub fn function_call_output_content_items_to_text(`
- `pub struct FunctionCallOutputPayload {`
- `pub enum FunctionCallOutputBody {`
- `pub fn to_text(&self) -> Option<String> {`
- `pub fn from_text(content: String) -> Self {`
- `pub fn from_content_items(content_items: Vec<FunctionCallOutputContentItem>) -> Self {`
- `pub fn text_content(&self) -> Option<&str> {`
- `pub fn text_content_mut(&mut self) -> Option<&mut String> {`
- `pub fn content_items(&self) -> Option<&[FunctionCallOutputContentItem]> {`
- `pub fn content_items_mut(&mut self) -> Option<&mut Vec<FunctionCallOutputContentItem>> {`

## Definitions (auto, per-file)
- `use` `codex-rs/protocol/src/models.rs:1` `use std::collections::HashMap;`
- `use` `codex-rs/protocol/src/models.rs:2` `use std::path::Path;`
- `use` `codex-rs/protocol/src/models.rs:4` `use codex_utils_image::load_and_resize_to_fit;`
- `use` `codex-rs/protocol/src/models.rs:5` `use serde::Deserialize;`
- `use` `codex-rs/protocol/src/models.rs:6` `use serde::Deserializer;`
- `use` `codex-rs/protocol/src/models.rs:7` `use serde::Serialize;`
- `use` `codex-rs/protocol/src/models.rs:8` `use serde::ser::Serializer;`
- `use` `codex-rs/protocol/src/models.rs:9` `use ts_rs::TS;`
- `use` `codex-rs/protocol/src/models.rs:11` `use crate::config_types::CollaborationMode;`
- `use` `codex-rs/protocol/src/models.rs:12` `use crate::config_types::SandboxMode;`
- `use` `codex-rs/protocol/src/models.rs:13` `use crate::protocol::AskForApproval;`
- `use` `codex-rs/protocol/src/models.rs:14` `use crate::protocol::COLLABORATION_MODE_CLOSE_TAG;`
- `use` `codex-rs/protocol/src/models.rs:15` `use crate::protocol::COLLABORATION_MODE_OPEN_TAG;`
- `use` `codex-rs/protocol/src/models.rs:16` `use crate::protocol::NetworkAccess;`
- `use` `codex-rs/protocol/src/models.rs:17` `use crate::protocol::SandboxPolicy;`
- `use` `codex-rs/protocol/src/models.rs:18` `use crate::protocol::WritableRoot;`
- `use` `codex-rs/protocol/src/models.rs:19` `use crate::user_input::UserInput;`
- `use` `codex-rs/protocol/src/models.rs:20` `use codex_execpolicy::Policy;`
- `use` `codex-rs/protocol/src/models.rs:21` `use codex_git::GhostCommit;`
- `use` `codex-rs/protocol/src/models.rs:22` `use codex_utils_image::error::ImageProcessingError;`
- `use` `codex-rs/protocol/src/models.rs:23` `use schemars::JsonSchema;`
- `use` `codex-rs/protocol/src/models.rs:25` `use crate::mcp::CallToolResult;`
- `enum` `codex-rs/protocol/src/models.rs:32` `pub enum SandboxPermissions {`
- `impl` `codex-rs/protocol/src/models.rs:40` `impl SandboxPermissions {`
- `fn` `codex-rs/protocol/src/models.rs:41` `pub fn requires_escalated_permissions(self) -> bool {`
- `enum` `codex-rs/protocol/src/models.rs:48` `pub enum ResponseInputItem {`
- `enum` `codex-rs/protocol/src/models.rs:69` `pub enum ContentItem {`
- `enum` `codex-rs/protocol/src/models.rs:81` `pub enum MessagePhase {`
- `enum` `codex-rs/protocol/src/models.rs:93` `pub enum ResponseItem {`
- `const` `codex-rs/protocol/src/models.rs:198` `pub const BASE_INSTRUCTIONS_DEFAULT: &str = include_str!("prompts/base_instructions/default.md");`
- `struct` `codex-rs/protocol/src/models.rs:203` `pub struct BaseInstructions {`
- `impl` `codex-rs/protocol/src/models.rs:207` `impl Default for BaseInstructions {`
- `fn` `codex-rs/protocol/src/models.rs:208` `fn default() -> Self {`
- `struct` `codex-rs/protocol/src/models.rs:219` `pub struct DeveloperInstructions {`
- `const` `codex-rs/protocol/src/models.rs:223` `const APPROVAL_POLICY_NEVER: &str = include_str!("prompts/permissions/approval_policy/never.md");`
- `const` `codex-rs/protocol/src/models.rs:224` `const APPROVAL_POLICY_UNLESS_TRUSTED: &str =`
- `const` `codex-rs/protocol/src/models.rs:226` `const APPROVAL_POLICY_ON_FAILURE: &str =`
- `const` `codex-rs/protocol/src/models.rs:228` `const APPROVAL_POLICY_ON_REQUEST: &str =`
- `const` `codex-rs/protocol/src/models.rs:230` `const APPROVAL_POLICY_ON_REQUEST_RULE: &str =`
- `const` `codex-rs/protocol/src/models.rs:233` `const SANDBOX_MODE_DANGER_FULL_ACCESS: &str =`
- `const` `codex-rs/protocol/src/models.rs:235` `const SANDBOX_MODE_WORKSPACE_WRITE: &str =`
- `const` `codex-rs/protocol/src/models.rs:237` `const SANDBOX_MODE_READ_ONLY: &str = include_str!("prompts/permissions/sandbox_mode/read_only.md");`
- `impl` `codex-rs/protocol/src/models.rs:239` `impl DeveloperInstructions {`
- `fn` `codex-rs/protocol/src/models.rs:244` `pub fn from(`
- `fn` `codex-rs/protocol/src/models.rs:274` `pub fn into_text(self) -> String {`
- `fn` `codex-rs/protocol/src/models.rs:278` `pub fn concat(self, other: impl Into<DeveloperInstructions>) -> Self {`
- `fn` `codex-rs/protocol/src/models.rs:287` `pub fn model_switch_message(model_instructions: String) -> Self {`
- `fn` `codex-rs/protocol/src/models.rs:293` `pub fn personality_spec_message(spec: String) -> Self {`
- `fn` `codex-rs/protocol/src/models.rs:300` `pub fn from_policy(`
- `fn` `codex-rs/protocol/src/models.rs:334` `pub fn from_collaboration_mode(collaboration_mode: &CollaborationMode) -> Option<Self> {`
- `fn` `codex-rs/protocol/src/models.rs:347` `fn from_permissions_with_network(`
- `fn` `codex-rs/protocol/src/models.rs:371` `fn from_writable_roots(writable_roots: Option<Vec<WritableRoot>>) -> Self {`
- `fn` `codex-rs/protocol/src/models.rs:392` `fn sandbox_text(mode: SandboxMode, network_access: NetworkAccess) -> DeveloperInstructions {`
- `const` `codex-rs/protocol/src/models.rs:404` `const MAX_RENDERED_PREFIXES: usize = 100;`
- `const` `codex-rs/protocol/src/models.rs:405` `const MAX_ALLOW_PREFIX_TEXT_BYTES: usize = 5000;`
- `const` `codex-rs/protocol/src/models.rs:406` `const TRUNCATED_MARKER: &str = "...\n[Some commands were truncated]";`
- `fn` `codex-rs/protocol/src/models.rs:408` `pub fn format_allow_prefixes(prefixes: Vec<Vec<String>>) -> Option<String> {`
- `fn` `codex-rs/protocol/src/models.rs:447` `fn prefix_combined_str_len(prefix: &[String]) -> usize {`
- `fn` `codex-rs/protocol/src/models.rs:451` `fn render_command_prefix(prefix: &[String]) -> String {`
- `impl` `codex-rs/protocol/src/models.rs:460` `impl From<DeveloperInstructions> for ResponseItem {`
- `fn` `codex-rs/protocol/src/models.rs:461` `fn from(di: DeveloperInstructions) -> Self {`
- `impl` `codex-rs/protocol/src/models.rs:474` `impl From<SandboxMode> for DeveloperInstructions {`
- `fn` `codex-rs/protocol/src/models.rs:475` `fn from(mode: SandboxMode) -> Self {`
- `fn` `codex-rs/protocol/src/models.rs:485` `fn should_serialize_reasoning_content(content: &Option<Vec<ReasoningItemContent>>) -> bool {`
- `fn` `codex-rs/protocol/src/models.rs:494` `fn local_image_error_placeholder(`
- `const` `codex-rs/protocol/src/models.rs:507` `pub const VIEW_IMAGE_TOOL_NAME: &str = "view_image";`
- `const` `codex-rs/protocol/src/models.rs:509` `const IMAGE_OPEN_TAG: &str = "<image>";`
- `const` `codex-rs/protocol/src/models.rs:510` `const IMAGE_CLOSE_TAG: &str = "</image>";`
- `const` `codex-rs/protocol/src/models.rs:511` `const LOCAL_IMAGE_OPEN_TAG_PREFIX: &str = "<image name=";`
- `const` `codex-rs/protocol/src/models.rs:512` `const LOCAL_IMAGE_OPEN_TAG_SUFFIX: &str = ">";`
- `const` `codex-rs/protocol/src/models.rs:513` `const LOCAL_IMAGE_CLOSE_TAG: &str = IMAGE_CLOSE_TAG;`
- `fn` `codex-rs/protocol/src/models.rs:515` `pub fn image_open_tag_text() -> String {`
- `fn` `codex-rs/protocol/src/models.rs:519` `pub fn image_close_tag_text() -> String {`
- `fn` `codex-rs/protocol/src/models.rs:523` `pub fn local_image_label_text(label_number: usize) -> String {`
- `fn` `codex-rs/protocol/src/models.rs:527` `pub fn local_image_open_tag_text(label_number: usize) -> String {`
- `fn` `codex-rs/protocol/src/models.rs:532` `pub fn is_local_image_open_tag_text(text: &str) -> bool {`
- `fn` `codex-rs/protocol/src/models.rs:537` `pub fn is_local_image_close_tag_text(text: &str) -> bool {`
- `fn` `codex-rs/protocol/src/models.rs:541` `pub fn is_image_open_tag_text(text: &str) -> bool {`
- `fn` `codex-rs/protocol/src/models.rs:545` `pub fn is_image_close_tag_text(text: &str) -> bool {`
- `fn` `codex-rs/protocol/src/models.rs:549` `fn invalid_image_error_placeholder(`
- `fn` `codex-rs/protocol/src/models.rs:562` `fn unsupported_image_error_placeholder(path: &std::path::Path, mime: &str) -> ContentItem {`
- `fn` `codex-rs/protocol/src/models.rs:572` `pub fn local_image_content_items_with_label_number(`
- `impl` `codex-rs/protocol/src/models.rs:619` `impl From<ResponseInputItem> for ResponseItem {`
- `fn` `codex-rs/protocol/src/models.rs:620` `fn from(item: ResponseInputItem) -> Self {`
- `enum` `codex-rs/protocol/src/models.rs:651` `pub enum LocalShellStatus {`
- `enum` `codex-rs/protocol/src/models.rs:659` `pub enum LocalShellAction {`
- `struct` `codex-rs/protocol/src/models.rs:664` `pub struct LocalShellExecAction {`
- `enum` `codex-rs/protocol/src/models.rs:674` `pub enum WebSearchAction {`
- `enum` `codex-rs/protocol/src/models.rs:703` `pub enum ReasoningItemReasoningSummary {`
- `enum` `codex-rs/protocol/src/models.rs:709` `pub enum ReasoningItemContent {`
- `impl` `codex-rs/protocol/src/models.rs:714` `impl From<Vec<UserInput>> for ResponseInputItem {`
- `fn` `codex-rs/protocol/src/models.rs:715` `fn from(items: Vec<UserInput>) -> Self {`
- `struct` `codex-rs/protocol/src/models.rs:746` `pub struct ShellToolCallParams {`
- `struct` `codex-rs/protocol/src/models.rs:767` `pub struct ShellCommandToolCallParams {`
- `enum` `codex-rs/protocol/src/models.rs:791` `pub enum FunctionCallOutputContentItem {`
- `fn` `codex-rs/protocol/src/models.rs:809` `pub fn function_call_output_content_items_to_text(`
- `fn` `codex-rs/protocol/src/models.rs:833` `fn from(item: crate::dynamic_tools::DynamicToolCallOutputContentItem) -> Self {`
- `struct` `codex-rs/protocol/src/models.rs:850` `pub struct FunctionCallOutputPayload {`
- `enum` `codex-rs/protocol/src/models.rs:857` `pub enum FunctionCallOutputBody {`
- `impl` `codex-rs/protocol/src/models.rs:862` `impl FunctionCallOutputBody {`
- `fn` `codex-rs/protocol/src/models.rs:869` `pub fn to_text(&self) -> Option<String> {`
- `impl` `codex-rs/protocol/src/models.rs:877` `impl Default for FunctionCallOutputBody {`
- `fn` `codex-rs/protocol/src/models.rs:878` `fn default() -> Self {`
- `impl` `codex-rs/protocol/src/models.rs:883` `impl FunctionCallOutputPayload {`
- `fn` `codex-rs/protocol/src/models.rs:884` `pub fn from_text(content: String) -> Self {`
- `fn` `codex-rs/protocol/src/models.rs:891` `pub fn from_content_items(content_items: Vec<FunctionCallOutputContentItem>) -> Self {`
- `fn` `codex-rs/protocol/src/models.rs:898` `pub fn text_content(&self) -> Option<&str> {`
- `fn` `codex-rs/protocol/src/models.rs:905` `pub fn text_content_mut(&mut self) -> Option<&mut String> {`
- `fn` `codex-rs/protocol/src/models.rs:912` `pub fn content_items(&self) -> Option<&[FunctionCallOutputContentItem]> {`
- `fn` `codex-rs/protocol/src/models.rs:919` `pub fn content_items_mut(&mut self) -> Option<&mut Vec<FunctionCallOutputContentItem>> {`
- `impl` `codex-rs/protocol/src/models.rs:930` `impl Serialize for FunctionCallOutputPayload {`
- `impl` `codex-rs/protocol/src/models.rs:942` `impl<'de> Deserialize<'de> for FunctionCallOutputPayload {`
- `impl` `codex-rs/protocol/src/models.rs:955` `impl From<&CallToolResult> for FunctionCallOutputPayload {`
- `fn` `codex-rs/protocol/src/models.rs:956` `fn from(call_tool_result: &CallToolResult) -> Self {`
- `fn` `codex-rs/protocol/src/models.rs:1009` `fn convert_mcp_content_to_items(`
- `enum` `codex-rs/protocol/src/models.rs:1014` `enum McpContent {`
- `impl` `codex-rs/protocol/src/models.rs:1057` `impl std::fmt::Display for FunctionCallOutputPayload {`
- `fn` `codex-rs/protocol/src/models.rs:1058` `fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {`
- `use` `codex-rs/protocol/src/models.rs:1073` `use super::*;`
- `use` `codex-rs/protocol/src/models.rs:1074` `use crate::config_types::SandboxMode;`
- `use` `codex-rs/protocol/src/models.rs:1075` `use crate::protocol::AskForApproval;`
- `use` `codex-rs/protocol/src/models.rs:1076` `use anyhow::Result;`
- `use` `codex-rs/protocol/src/models.rs:1077` `use codex_execpolicy::Policy;`
- `use` `codex-rs/protocol/src/models.rs:1078` `use pretty_assertions::assert_eq;`
- `use` `codex-rs/protocol/src/models.rs:1079` `use std::path::PathBuf;`
- `use` `codex-rs/protocol/src/models.rs:1080` `use tempfile::tempdir;`
- `fn` `codex-rs/protocol/src/models.rs:1083` `fn convert_mcp_content_to_items_preserves_data_urls() {`
- `fn` `codex-rs/protocol/src/models.rs:1100` `fn convert_mcp_content_to_items_builds_data_urls_when_missing_prefix() {`
- `fn` `codex-rs/protocol/src/models.rs:1117` `fn convert_mcp_content_to_items_returns_none_without_images() {`
- `fn` `codex-rs/protocol/src/models.rs:1127` `fn function_call_output_content_items_to_text_joins_text_segments() {`
- `fn` `codex-rs/protocol/src/models.rs:1145` `fn function_call_output_content_items_to_text_ignores_blank_text_and_images() {`
- `fn` `codex-rs/protocol/src/models.rs:1160` `fn function_call_output_body_to_text_returns_plain_text_content() {`
- `fn` `codex-rs/protocol/src/models.rs:1167` `fn function_call_output_body_to_text_uses_content_item_fallback() {`
- `fn` `codex-rs/protocol/src/models.rs:1182` `fn converts_sandbox_mode_into_developer_instructions() {`
- `fn` `codex-rs/protocol/src/models.rs:1201` `fn builds_permissions_with_network_access_override() {`
- `fn` `codex-rs/protocol/src/models.rs:1223` `fn builds_permissions_from_policy() {`
- `fn` `codex-rs/protocol/src/models.rs:1244` `fn includes_request_rule_instructions_when_enabled() {`
- `fn` `codex-rs/protocol/src/models.rs:1268` `fn render_command_prefix_list_sorts_by_len_then_total_len_then_alphabetical() {`
- `fn` `codex-rs/protocol/src/models.rs:1292` `fn render_command_prefix_list_limits_output_to_max_prefixes() {`
- `fn` `codex-rs/protocol/src/models.rs:1304` `fn format_allow_prefixes_limits_output() {`
- `fn` `codex-rs/protocol/src/models.rs:1324` `fn serializes_success_as_plain_string() -> Result<()> {`
- `fn` `codex-rs/protocol/src/models.rs:1339` `fn serializes_failure_as_string() -> Result<()> {`
- `fn` `codex-rs/protocol/src/models.rs:1356` `fn serializes_image_outputs_as_array() -> Result<()> {`
- `fn` `codex-rs/protocol/src/models.rs:1400` `fn preserves_existing_image_data_urls() -> Result<()> {`
- `fn` `codex-rs/protocol/src/models.rs:1428` `fn deserializes_array_payload_into_items() -> Result<()> {`
- `fn` `codex-rs/protocol/src/models.rs:1458` `fn deserializes_compaction_alias() -> Result<()> {`
- `fn` `codex-rs/protocol/src/models.rs:1473` `fn roundtrips_web_search_call_actions() -> Result<()> {`
- `fn` `codex-rs/protocol/src/models.rs:1562` `fn deserialize_shell_tool_call_params() -> Result<()> {`
- `fn` `codex-rs/protocol/src/models.rs:1585` `fn wraps_image_user_input_with_tags() -> Result<()> {`
- `fn` `codex-rs/protocol/src/models.rs:1612` `fn local_image_read_error_adds_placeholder() -> Result<()> {`
- `fn` `codex-rs/protocol/src/models.rs:1645` `fn local_image_non_image_adds_placeholder() -> Result<()> {`
- `fn` `codex-rs/protocol/src/models.rs:1678` `fn local_image_unsupported_image_format_adds_placeholder() -> Result<()> {`

## Dependencies (auto sample)
### Imports / Includes
- `use std::collections::HashMap;`
- `use std::path::Path;`
- `use codex_utils_image::load_and_resize_to_fit;`
- `use serde::Deserialize;`
- `use serde::Deserializer;`
- `use serde::Serialize;`
- `use serde::ser::Serializer;`
- `use ts_rs::TS;`
- `use crate::config_types::CollaborationMode;`
- `use crate::config_types::SandboxMode;`
- `use crate::protocol::AskForApproval;`
- `use crate::protocol::COLLABORATION_MODE_CLOSE_TAG;`
- `use crate::protocol::COLLABORATION_MODE_OPEN_TAG;`
- `use crate::protocol::NetworkAccess;`
- `use crate::protocol::SandboxPolicy;`
- `use crate::protocol::WritableRoot;`
- `use crate::user_input::UserInput;`
- `use codex_execpolicy::Policy;`
- `use codex_git::GhostCommit;`
- `use codex_utils_image::error::ImageProcessingError;`
### Referenced env vars
- (none detected)

## Error Handling / Edge Cases
- has retry/timeout/backoff logic
- returns structured errors (Result/ErrorKind)
- uses Rust panic/expect/unwrap-style failure paths

## Spec Links
- `docs/workdocjcl/spec/02_Data/ROLLOUT_FORMAT.md`
